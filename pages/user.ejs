<!DOCTYPE html>
<html lang="en">

<%- include('../partials/head.ejs', {page: "user"}); %>


<body class='bg-gray-100'>
    <%- include('../partials/nav.ejs', {active: "user_"+user.name, user:loggedInUser}); %>
    <main class='container mx-auto px-4 mt-24 md:mt-16'>
        <img src="/picture/<%= user.name %>" height="30px" class='rounded-full h-10 inline-block shadow'>
        <h1 class="inline-block font-bold">@<%= user.name %></h1>
        <p class="text-gray-700 italic">id: <%= user._id %></p>
        <% posts.forEach(post => { %>
        <div
            class="max-w-2xl flex p-6 mx-auto my-5 bg-white rounded-lg shadow-md <%= activePost==post._id ? 'bg-indigo-100' : 'bg-white' %>">
            <div class="pt-1">
                <img src="/picture/<%= post.poster %>" height="30px" class='rounded-full h-6 inline-block shadow'>
                <h4 class="inline-block text-xl text-gray-900 leading-tight align-middle">@<%= post.poster %></h4>
                <p class="text-base text-gray-600 leading-normal"><%= post.content %></p>
                <p class="text-base text-gray-500 italic leading-normal">
                    <%= new Date(post.time).toLocaleDateString("en-US") + ' ' + new Date(post.time).toLocaleTimeString("en-US") %>
                    - <%= post._id %></p>
                <% if(loggedInUser) { %>
                <div>
                    <span class='love <%= post.loves && post.loves.includes(loggedInUser.username) ? 'text-red-600' : '' %>'>
                        <span data-post-id='<%= post._id %>'
                            class="iconify inline-block hover:text-red-400 transition-color duration-200 cursor-pointer"
                            data-icon="uil:heart" data-inline="true"></span>
                    </span>

                    <span data-post-count-id='<%= post._id %>'><%= post.loves ? post.loves.length : '0' %></span>
                    <!-- text-red-600 -->

                    <!-- 
                    <span data-post-id='<%= post._id %> '
                        class="fav iconify inline-block hover:text-yellow-400 transition-color duration-200 cursor-pointer"
                        data-icon="uil:star" data-inline="true"></span>
                    -->

                    <!-- text-yellow-500 -->

                </div>
                <% } %>
            </div>
        </div>
        <% }) %>
    </main>
</body>

<%- include('../partials/scripts.ejs'); %>
<script defer>
    console.log('user script loaded')
    var loves = document.querySelectorAll('.love')
    var favs = document.querySelectorAll('.fav')

    loves.forEach(btn => {
        var id = btn.children[0].dataset.postId

        btn.addEventListener('click', e => {
            love(id, (newCount, action)=>{
                console.log('loved')
                if(action == 'love') {
                    btn.classList.add('text-red-600') 
                }
                if(action == 'unlove') {
                    btn.classList.remove('text-red-600')
                }
                document.querySelector(`[data-post-count-id='${id}']`).innerText = newCount
            })
        })
    })

/*     favs.forEach(btn => {
        var id = btn.dataset.postId

        btn.addEventListener('click', e => {
            if (btn.classList.contains('text-yellow-500')) {
                //unfav
                btn.classList.remove('text-yellow-500')
            } else {
                //fab
                btn.classList.add('text-yellow-500')
            }
        })
    }) */

    async function love(id, callback) {
        console.log(`loving ${id}`)
        var loveres = await fetch(`/posts/${id}/love`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        var lovejson = await loveres.json()
        console.log(lovejson)
        if (lovejson.ok) {
            var action = lovejson.action
            var newCount = lovejson.new
            if(action == 'love') callback(newCount, 'love')
            if(action == 'unlove') callback(newCount, 'unlove')
        }
    }
</script>

</html>